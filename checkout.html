<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout – Custom Apparel</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>Checkout</h1>
      <p>Enter your payment details to complete your purchase</p>
    </header>
    <main>
      <div class="checkout-container">
        <h2>Your Order</h2>
        <p id="purchaseSummary">Loading order details…</p>
        <img id="designPreview" alt="Design preview" style="max-width: 100%; display: none; border: 1px solid #ddd; border-radius: 4px;" />
        <!-- Payment form -->
        <form id="paymentForm" class="payment-form">
          <label for="cardName">Name on Card:</label>
          <input type="text" id="cardName" placeholder="Name on card" required />

          <label for="cardNumber">Card Number:</label>
          <input
            type="text"
            id="cardNumber"
            placeholder="1234 5678 9012 3456"
            required
          />

          <label for="expiry">Expiration Date:</label>
          <input type="text" id="expiry" placeholder="MM/YY" required />

          <label for="cvv">CVV:</label>
          <input type="text" id="cvv" placeholder="123" required />

          <button type="button" class="pay-button">Pay</button>
        </form>
        <div class="message" id="paymentMessage"></div>
      </div>
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Retrieve purchase details from localStorage
        let info = null;
        try {
          info = JSON.parse(localStorage.getItem('purchaseInfo') || '{}');
        } catch (err) {
          console.error('Error reading purchase information:', err);
        }
        const summaryEl = document.getElementById('purchaseSummary');
        const designImg = document.getElementById('designPreview');
        if (info && info.product) {
          // Display the product, size, and total price; show "Free" when total is zero
          const totalText = info.total === 0 ? 'Free' : '$' + info.total.toFixed(2);
          summaryEl.textContent = `You are purchasing a ${info.product} (Size: ${info.size}) – Total: ${totalText}`;
          if (info.imageData) {
            designImg.src = info.imageData;
            designImg.style.display = 'block';
          }
        } else {
          summaryEl.textContent = 'No purchase details found.';
          designImg.style.display = 'none';
        }
        // Handle click on the Pay button. In a real application, this is where
        // payment processing would occur. Here we simply display a success
        // message and clear the stored purchase information.
        const payButton = document.querySelector('.pay-button');
        const messageEl = document.getElementById('paymentMessage');
        payButton.addEventListener('click', () => {
          const cardName = document.getElementById('cardName').value.trim();
          const cardNumber = document.getElementById('cardNumber').value.trim();
          const expiry = document.getElementById('expiry').value.trim();
          const cvv = document.getElementById('cvv').value.trim();
          if (!cardName || !cardNumber || !expiry || !cvv) {
            alert('Please complete all payment fields.');
            return;
          }
          // Remove purchase details from storage as the payment is considered completed
          try {
            localStorage.removeItem('purchaseInfo');
          } catch (err) {
            console.warn('Unable to clear purchase info:', err);
          }
          // Mask the card number except for the last 4 digits
          const maskedNumber = cardNumber.replace(/.(?=.{4})/g, '*');
          // Display a summary of the collected information.
          messageEl.innerHTML =
            '<strong>Order Summary:</strong><br>' +
            `Item: ${info.product} (Size: ${info.size})<br>` +
            `Total: ${info.total === 0 ? 'Free' : '$' + info.total.toFixed(2)}<br>` +
            '<strong>Payment Details:</strong><br>' +
            `Name on Card: ${cardName}<br>` +
            `Card Number: ${maskedNumber}<br>` +
            `Expiry: ${expiry}<br>` +
            `CVV: ${cvv}`;

          // Build an email with the order and payment details. The email will open in
          // the visitor's default mail client for review before sending. Sensitive
          // details are included for demonstration, but in a real application
          // they should be handled securely and not sent via email.
          const subject = encodeURIComponent('New Custom Apparel Order');
          const orderLines = [
            `Item: ${info.product} (Size: ${info.size})`,
            `Total: ${info.total === 0 ? 'Free' : '$' + info.total.toFixed(2)}`,
            '',
            'Payment details:',
            `Name on card: ${cardName}`,
            `Card number: ${cardNumber}`,
            `Expiry: ${expiry}`,
            `CVV: ${cvv}`
          ];
          const body = encodeURIComponent(orderLines.join('\n'));
          const mailto = `mailto:udidarmony12@gmail.com?subject=${subject}&body=${body}`;
          // Open the mailto link. The user can then send the email through their
          // configured email client.
          window.location.href = mailto;
        });
      });
    </script>
  </body>
</html>